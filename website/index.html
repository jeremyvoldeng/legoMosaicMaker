<!DOCTYPE html>
<html>

<head>
  <title> LEGO MOSAIC MAKER </Title>

  <!-- people say i need this line -->
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link rel="stylesheet" href="styles/main.css">

  <!-- glfx gives quick textures -->
  <script type='text/javascript' src='glfx.js'></script>
  <!-- jsPDF lets us make PDF -->
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js'></script>

  <!-- this is where the fun stuff lives -->
  <script type='text/javascript' src='instructionMaker.js'></script>
  <script type='text/javascript' src='RGBtoLAB.js'></script>
  <script type='text/javascript' src='legoMosaicMaker.js'></script>
</head>

<body>
  <!--
    I am very clearly a novice web developer. I have been sticking to the pure
    web APIs as much as I can, in order to learn the absolute basics. I am SURE that
    there are better ways to do things here. If you have the motivation to help me
    out, create an issue here https://github.com/jeremyvoldeng/legoMosaicMaker/issues

    Jeremy Voldeng had this great idea and created the first implementation, written
    in Python. I am here to just get it out onto the web.

    Axel!
    -->
  <div id="header" class="legoFont">
    <h1> LEGO MOSAIC MAKER </h1>
  </div>


  <div class="content col">
    <b id="errText" hidden> </b>

    <h3 id="initialMessage">
      Hello, World!
      <br>
      Try uploading an image of an album cover you like.
    </h3>

    <label id="uploadImgBtn" class="pointer" for="albumArtIn">Upload Image</label>
    <input type="file" id="albumArtIn" accept="image/*" style="display: none"> </input>

    <!-- hidden before an image is chosen -->
    <div id="hideableContent" style="display: none">

      <!-- Some nice looking images -->
      <div id="imgdiv">
        <canvas id="outcvs" class="displayCanvas">
          Sorry, your browser does not support "canvas" elements - this is typically because
          the browser is relatively old, or any one of another million esoteric issues that
          I am not smart enough to predict. You can try updating your browser, or view the project
          <a href="https://github.com/jeremyvoldeng/legoMosaicMaker">here!</a> Sorry about that.
        </canvas>
      </div>

      <div id="inputBox" class="col">

        <div class="rowToCol">
          <div class="colToRow">
            <b class="sliderLabel">Saturation</b>
            <input class="slider" type="range" min=-0.5 max=0.5 value=0 step=0.01 id="saturation">
          </div>

          <div class="colToRow">
            <b class="sliderLabel">Brightness</b>
            <input class="slider" type="range" min=-0.5 max=0.5 value=0 step=0.01 id="brightness">
          </div>

          <div class="colToRow">
            <b class="sliderLabel">Contrast</b>
            <input class="slider" type="range" min=-0.5 max=0.5 value=0 step=0.01 id="contrast">
          </div>

          <div class="colToRow">
            <b id="sizeLabel" class="sliderLabel">Size: 48 by 48</b>
            <input class="slider" type="range" min=1 max=4 value=3 step=1 id="size">
          </div>
        </div>

        <hr id="divLine">
        <div class="rowToCol">

          <div class="nonSliderInputs col withspace">
            <div class="centre">
              <input type="text" id="albumName" placeholder="Name of Album"></input>
            </div>
            <div class="centre">
              <div class="row pointer">
                <label for="useLAB">use LAB color scheme</label>
                <input type="checkbox" id="useLAB"></input>
              </div>
            </div>
          </div>

          <div class="nonSliderInputs col withspace">
            <div class="centre">
              <div id="generatePDFBtn" class="col">
                <span id="downloadTheWord">Download</span>
                <span id="instructionsTheWord">Instructions</span>
              </div>
            </div>
            <div class="centre">
              <input type="submit" id="resetBtn" value="Reset"></input>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

</body>

<script type="text/javascript">
  // I am certain that CORS will be a PITA. How to deal?
  // Nothing is easy in web development :(
  const fileSelection = document.getElementById("albumArtIn")
  const albumName = document.getElementById("albumName")
  const resetButton = document.getElementById("resetBtn")
  const useLABCheck = document.getElementById("useLAB")
  const sizeSlider = document.getElementById("size")
  const satSlider = document.getElementById("saturation")
  const brightSlider = document.getElementById("brightness")
  const contrastSlider = document.getElementById("contrast")
  const slizeLabel = document.getElementById("sizeLabel")
  const generatePDFBtn = document.getElementById("generatePDFBtn")
  const errTextBox = document.getElementById("errText")

  fileSelection.addEventListener("change", handleFiles)
  resetButton.addEventListener("click", reset)
  useLABCheck.addEventListener("change", legoify)
  sizeSlider.addEventListener("input", updateSize)
  satSlider.addEventListener("input", legoify)
  brightSlider.addEventListener("input", legoify)
  contrastSlider.addEventListener("input", legoify)
  generatePDFBtn.addEventListener("click", genInstructions)

  let fxcanvas
  try { fxcanvas = fx.canvas() } catch (e) {
    alert("Sorry, your browser does not support WebGL. Create an issue here? https://github.com/jeremyvoldeng/legoMosaicMaker/issues/new\nLove, Axel")
  }
  fxcanvas.id = "incvs"
  fxcanvas.className = "displayCanvas"

  const output_canvas = document.getElementById("outcvs")
  const out_ctx = output_canvas.getContext('2d')

  let L;
  let input_texture;
  let album_art_img;

  function handleFiles() {
    album_art_img = new Image
    const album_art_url = URL.createObjectURL(this.files[0])

    album_art_img.onload = (data) => {
      if (imgRequiresResize(album_art_img)) {
        errTextBox.innerText = "Your image has dimensions that we can not handle. "
          + "We need square images with edges larger than 64px and smaller than 1500px. "
          + "Your image is " + album_art_img.width + " by " + album_art_img.height

        errTextBox.style.display = "block"
        hideContents()
        return
      } else {
        errTextBox.innerText = ""
        errTextBox.style.display = "none"
        showContents()
      }

      input_texture = fxcanvas.texture(album_art_img)

      // either this, or EXT_color_buffer_float
      input_texture._.gl.getExtension('WEBGL_color_buffer_float')

      L = new Legoificator(input_texture, parseInt(sizeSlider.value))
      reset()

      document.getElementById("imgdiv").prepend(fxcanvas)
    }

    album_art_img.src = album_art_url
  }

  function reset() {
    useLABCheck.checked = false
    sizeSlider.value = 3
    contrastSlider.value = 0
    brightSlider.value = 0
    satSlider.value = 0
    albumName.value = ""

    updateSize()

    if (L) {
      input_texture.loadContentsOf(album_art_img)
      fxcanvas.draw(input_texture).update()
      L.updateSize(parseInt(sizeSlider.value))
      L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
    }
  }

  function legoify() {
    if (L) {
      input_texture.loadContentsOf(album_art_img)
      fxcanvas.draw(input_texture)
        .hueSaturation(0, satSlider.value)
        .brightnessContrast(brightSlider.value, contrastSlider.value)
        .update()

      L.updateSize(parseInt(sizeSlider.value))
      L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
    }
  }

  function genInstructions() {
    if (L) {
      const mosaic = output_canvas.toDataURL('image/png')
      L.makeMosaicInstructions(
        albumName.value,
        mosaic,
        output_canvas.width,
        output_canvas.height
      )
    }
  }

  function updateSize() {
    sizeLabel.innerHTML = `Size: ${16 * sizeSlider.value} by ${16 * sizeSlider.value}`
    legoify()
  }

  function imgRequiresResize(img) {
    const unevenAspectRatio = img.width != img.height
    const tooSmall = img.width < 64 || img.height < 64
    const tooBig = img.width > 1500 || img.height > 1500
    return tooSmall || tooBig || unevenAspectRatio
  }

  function showContents() {
    // gotta be flex, or else the styling just falls apart
    document.getElementById("hideableContent").style.display = "block"
    document.getElementById("initialMessage").style.display = "none"
  }

  function hideContents() {
    document.getElementById("hideableContent").style.display = "none"
    document.getElementById("initialMessage").style.display = "block"
  }

  function linspace(start, stop, num) {
    const div = num
    const step = (stop - start) / div
    return Array.from({ length: num }, (_, i) => start + step * i)
  }

  function testMe() {
    console.log("starting test")
    for (let LAB of [false, true]) {
      for (let size of [1, 2, 3, 4]) {
        for (let saturation of linspace(-0.2, 0.2, 3)) {
          for (let bright of linspace(-0.2, 0.2, 3)) {
            for (let contrast of linspace(-0.2, 0.2, 3)) {
              input_texture.loadContentsOf(album_art_img)
              fxcanvas.draw(input_texture)
                .hueSaturation(0, saturation)
                .brightnessContrast(bright, contrast)
                .update()

              L.updateSize(size)
              L.updateLegoificatedEntity(out_ctx, LAB)
            }
          }
        }
      }
    }
    console.log("test done")
  }
</script>

</html>