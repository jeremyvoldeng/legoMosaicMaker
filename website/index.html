<!DOCTYPE html>
<html>
  <head>
    <title> LEGO MOSAIC MAKER </Title>

    <link rel="stylesheet" href="styles/main.css">

    <script type='text/javascript' src='glfx.js'></script>
    <script type='text/javascript' src='colorConversions.js'></script>
    <script type='text/javascript' src='legoMosaicMaker.js'></script>
  </head>

  <body class="content">
    <!--
      I am very clearly a novice web developer. I have been sticking to the pure
      web APIs as much as I can, in order to learn the absolute basics. I am SURE that
      there are better ways to do things here. If you have the motivation to help me
      out, create an issue here https://github.com/jeremyvoldeng/legoMosaicMaker/issues

      Jeremy Voldeng had this great idea and created the first implementation, written
      in Python. I am here to just get it out onto the web.

      Axel!
    -->
    <div class="homeheader">
      <h2 class="titleCard name">
        LEGO MOSAIC MAKER
      </h2>
    </div>

    <div class="lego-zone" id="da-zone">

      <!-- Inputs -->
      <div class="col-cls">
        <input type="file" id="albumArtIn" type="image/*"> </input>

        <div class="col-cls">
          <div class="row-cls">
            <input type="checkbox" id="useLAB"> use LAB color scheme </input>
          </div>
          <button id="reset">Reset image</input>
        </div>

        <div class="slidecontainer row-cls">
          <div class="col-cls">
            <b>Saturation</b>
            <b>Brightness</b>
            <b>Contrast</b>
            <b>Size</b>
          </div>
          <div class="col-cls">
            <input type="range" min=-0.2 max=0.2 value=0 step=0.01 class="slider" id="saturation">
            <input type="range" min=-0.2 max=0.2 value=0 step=0.01 class="slider" id="brightness">
            <input type="range" min=-0.2 max=0.2 value=0 step=0.01 class="slider" id="contrast">
            <input type="range" min=1 max=4 value=3 step=1 class="slider" id="size">
          </div>
        </div>

      </div>

      <!-- Some nice looking images -->
      <div class="row-cls" id="imgdiv">
        <canvas id="outcvs">
          Sorry, your browser does not support "canvas" elements - this is typically because
          the browser is relatively old. You can try updating your browser, or view the project
          <a href="https://github.com/jeremyvoldeng/legoMosaicMaker">here!</a> Sorry about that.
        </canvas>
      </div>
    </div>
  </body>

  <script>
    // I am certain that CORS will be a PITA. How to deal?
    // Nothing is easy in web development :(
    const fileSelection = document.getElementById("albumArtIn")
    const resetButton   = document.getElementById("reset")
    const useLABCheck   = document.getElementById("useLAB")
    const sizeSlider    = document.getElementById("size")
    const satSlider     = document.getElementById("saturation")
    const brightSlider  = document.getElementById("brightness")
    const contrastSlider = document.getElementById("contrast")

    fileSelection.addEventListener("change", handleFiles)
    resetButton.addEventListener("click", reset)
    useLABCheck.addEventListener("change", legoify)
    sizeSlider.addEventListener("input", legoify)

    satSlider.addEventListener("input", legoify)
    brightSlider.addEventListener("input", legoify)
    contrastSlider.addEventListener("input", legoify)

    let fxcanvas
    try {
          fxcanvas = fx.canvas()
        } catch (e) {
              alert(e)
            }

    const canvas = document.getElementById("cvs")
    const output_canvas = document.getElementById("outcvs")

    const out_ctx = output_canvas.getContext('2d')

    let L;
    let input_texture;
    let album_art_img;

    function handleFiles() {
          album_art_img = new Image
          const album_art_url = URL.createObjectURL(this.files[0])

          album_art_img.onload = (data) => {
                input_texture = fxcanvas.texture(album_art_img)
                original_texture = fxcanvas.texture(album_art_img)

                fxcanvas.draw(input_texture).update()

                L = new Legoificator(input_texture)
                L.commenceLegoification(out_ctx, useLABCheck.checked)

                document.getElementById("imgdiv").prepend(fxcanvas)
              }

          album_art_img.src = album_art_url
        }

    function reset() {
          useLABCheck.checked = false
          sizeSlider.value = 3
          contrastSlider.value = 0
          brightSlider.value = 0
          satSlider.value = 0

          if (L) {
                input_texture.loadContentsOf(album_art_img)
                fxcanvas.draw(input_texture).update()
                L.updateSize(parseInt(sizeSlider.value))
                L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
              }
        }

    function legoify() {
          if (L) {
                input_texture.loadContentsOf(album_art_img)
                fxcanvas.draw(input_texture)
                  .hueSaturation(0, satSlider.value)
                  .brightnessContrast(brightSlider.value, contrastSlider.value)
                  .update()

                L.updateSize(parseInt(sizeSlider.value))
                L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
              }
        }
  </script>
</html>
