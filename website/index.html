<!DOCTYPE html>
<html>
  <head>
    <title> LEGO MOSAIC MAKER </Title>

    <link rel="stylesheet" href="styles/main.css">

    <script type='text/javascript' src='glfx.js'></script>
    <script type='text/javascript' src='colorConversions.js'></script>
    <script type='text/javascript' src='legoMosaicMaker.js'></script>
  </head>

  <body class="content">
    <!--
      I am very clearly a novice web developer. I have been sticking to the pure
      web APIs as much as I can, in order to learn the absolute basics. I am SURE that
      there are better ways to do things here. If you have the motivation to help me
      out, create an issue here https://github.com/jeremyvoldeng/legoMosaicMaker/issues

      Jeremy Voldeng had this great idea and created the first implementation, written
      in Python. I am here to just get it out onto the web.

      Axel!
    -->
    <div class="homeheader">
      <h2 class="titleCard name">
        LEGO MOSAIC MAKER
      </h2>
    </div>

    <div class="lego-zone" id="da-zone">

      <!-- Inputs -->
      <div class="col-cls">
        <input type="file" id="albumArtIn" type="image/*"> </input>

        <div class="col-cls">
          <div class="row-cls">
            <input type="checkbox" id="useLAB"> use LAB color scheme </input>
          </div>
          <button id="reset">Reset image</input>
        </div>

        <div class="slidecontainer row-cls">
          <div class="col-cls">
            <b>Saturation</b>
            <b>Brightness</b>
            <b>Contrast</b>
          </div>
          <div class="col-cls">
            <input type="range" min="-0.2" max="0.2" value="0" step=0.01 class="slider" id="saturation">
            <input type="range" min="-0.2" max="0.2" value="0" step=0.01 class="slider" id="brightness">
            <input type="range" min="-0.2" max="0.2" value="0" step=0.01 class="slider" id="contrast">
          </div>
        </div>

      </div>

      <!-- Some nice looking images -->
      <div class="row-cls" id="imgdiv">
        <canvas id="outcvs">
          Sorry, your browser does not support "canvas" elements - this is typically because
          the browser is relatively old. You can try updating your browser, or view the project
          <a href="https://github.com/jeremyvoldeng/legoMosaicMaker">here!</a> Sorry about that.
        </canvas>
      </div>
    </div>
  </body>

  <script>
    // I am certain that CORS will be a PITA. How to deal?
    // Nothing is easy in web development :(
    window.onload = () => {
          const fileSelection = document.getElementById("albumArtIn")
          const resetButton   = document.getElementById("reset")
          const useLABCheck   = document.getElementById("useLAB")
          const satSlider     = document.getElementById("saturation")
          const brightSlider  = document.getElementById("brightness")
          const contrastSlider = document.getElementById("contrast")

          fileSelection.addEventListener("change", handleFiles)
          resetButton.addEventListener("click", reset)
          useLABCheck.addEventListener("change", legoify)
          satSlider.addEventListener("change", changeSaturation)
          brightSlider.addEventListener("change", changeBrightnessAndContrast)
          contrastSlider.addEventListener("change", changeBrightnessAndContrast)

          let fxcanvas
          try {
                fxcanvas = fx.canvas()
              } catch (e) {
                    alert(e)
                  }

          const canvas = document.getElementById("cvs")
          const output_canvas = document.getElementById("outcvs")

          const out_ctx = output_canvas.getContext('2d')

          let L;
          let input_texture;
          function handleFiles() {
                const album_art_img = new Image
                const album_art_url = URL.createObjectURL(this.files[0])

                album_art_img.onload = (data) => {
                      input_texture = fxcanvas.texture(album_art_img)

                      fxcanvas.draw(input_texture).update()

                      L = new Legoificator(input_texture)
                      L.commenceLegoification(out_ctx, useLABCheck.checked)

                      document.getElementById("imgdiv").prepend(fxcanvas)
                    }

                album_art_img.src = album_art_url
              }

          function reset() {
                if (L) {
                      fxcanvas.draw(input_texture).update()
                      L.resizeImage()
                      L.commenceLegoification(out_ctx)
                    }

                useLABCheck.checked = false
                contrastSlider.value = 0
                brightSlider.value = 0
                satSlider.value = 0
              }

          function legoify() {
                if (L) {
                      fxcanvas.draw(input_texture)
                        .hueSaturation(0, satSlider.value)
                        .brightnessContrast(brightSlider.value, contrastSlider.value)
                        .update()
                      L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
                    }
              }

          function changeSaturation() {
                if (L) {
                      fxcanvas.draw(input_texture)
                        .hueSaturation(0, satSlider.value)
                        .update()
                      L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
                    }
              }

          function changeBrightnessAndContrast() {
                if (L) {
                      fxcanvas.draw(input_texture)
                        .brightnessContrast(brightSlider.value, contrastSlider.value)
                        .update()
                      L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
                    }
              }
        }
  </script>
</html>
