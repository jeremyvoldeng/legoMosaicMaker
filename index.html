<!DOCTYPE html>
<html>

<head>
  <title> LEGO MOSAIC MAKER </Title>

  <!-- people say i need this line -->
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link rel="stylesheet" href="styles/main.css">

  <!-- glfx gives quick textures -->
  <script type='text/javascript' src='glfx.js'></script>
  <!-- jsPDF lets us make PDF -->
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js'></script>

  <!-- this is where the fun stuff lives -->
  <script type='text/javascript' src='instructionMaker.js'></script>
  <script type='text/javascript' src='RGBtoLAB.js'></script>
  <script type='text/javascript' src='legoMosaicMaker.js'></script>
</head>

<body>
  <!--
    I am very clearly a novice web developer. I have been sticking to the pure
    web APIs as much as I can, in order to learn the absolute basics. I am SURE that
    there are better ways to do things here. If you have the motivation to help me
    out, create an issue here https://github.com/jeremyvoldeng/legoMosaicMaker/issues

    Jeremy Voldeng had this great idea and created the first implementation, written
    in Python. I am here to just get it out onto the web.

    Axel!
    -->
  <div id="header" class="legoFont">
    <h1> LEGO MOSAIC MAKER </h1>
  </div>


  <div class="content col">
    <b id="errText" hidden> </b>

    <h3 id="initialMessage">
      Hello, World!
      <br>
      Try uploading an image of an album cover you like.
    </h3>

    <label id="uploadImgBtn" class="pointer" for="albumArtIn">Upload Image</label>
    <input type="file" id="albumArtIn" accept="image/*" style="display: none"> </input>

    <p>
      or, submit a URL to an image
    </p>

    <form id="urlSubmission" class="row">
      <input type="url" id="albumArtURL" list="defaultURLs" pattern="https://.*" required></input>
      <input type="submit" id="albumArtURLBtn" value="Submit URL">
    </form>

    <!-- datalist with id defaultURLs with URLs to album covers of Abbey Road, In Rainbows, Madvillany, and one more album cover, with the correct labels -->

    <datalist id="defaultURLs">
      <!-- option of a picture to Lenna -->
      <option value="https://upload.wikimedia.org/wikipedia/en/7/7d/Lenna_%28test_image%29.png">Lenna</option>
      <option value="https://upload.wikimedia.org/wikipedia/en/3/3b/Dark_Side_of_the_Moon.png"
        label="Dark Side of the Moon">
      <option value="https://upload.wikimedia.org/wikipedia/en/1/14/Inrainbowscover.png" label="In Rainbows">
      <option value="https://upload.wikimedia.org/wikipedia/en/5/5e/Madvillainy_cover.png" label="Madvillany">
      <option value="https://media.pitchfork.com/photos/5929beaf5e6ef959693232a4/1:1/w_450%2Cc_limit/3b9fa8c5.jpg"
        label="Positive Force">
    </datalist>

    <!-- hidden before an image is chosen -->
    <div id="hideableContent" style="display: none">

      <!-- Some nice looking images -->
      <div id="imgdiv">
        <canvas id="outcvs" class="displayCanvas">
          Sorry, your browser does not support "canvas" elements - this is typically because
          the browser is relatively old, or any one of another million esoteric issues that
          I am not smart enough to predict. You can try updating your browser, or view the project
          <a href="https://github.com/jeremyvoldeng/legoMosaicMaker">here!</a> Sorry about that.
        </canvas>
      </div>

      <div id="inputBox" class="col">

        <div class="rowToCol">
          <div class="colToRow">
            <b class="sliderLabel">Saturation</b>
            <input class="slider" type="range" min=-0.5 max=0.5 value=0 step=0.01 id="saturation">
          </div>

          <div class="colToRow">
            <b class="sliderLabel">Brightness</b>
            <input class="slider" type="range" min=-0.5 max=0.5 value=0 step=0.01 id="brightness">
          </div>

          <div class="colToRow">
            <b class="sliderLabel">Contrast</b>
            <input class="slider" type="range" min=-0.5 max=0.5 value=0 step=0.01 id="contrast">
          </div>

          <div class="colToRow">
            <b id="sizeLabel" class="sliderLabel">Size: 48 by 48</b>
            <input class="slider" type="range" min=1 max=4 value=3 step=1 id="size">
          </div>
        </div>

        <hr class="divLine">

        <div class="rowToCol">

          <div class="nonSliderInputs col withspace">
            <div class="centre">
              <input type="text" id="albumName" placeholder="Name of Album"></input>
            </div>
            <div class="centre">
              <div class="row pointer">

                <label for="useLAB">
                  <!-- Open in new tab -->
                  <a href="https://en.wikipedia.org/wiki/CIELAB_color_space" target="_blank" rel="noopener">
                    use LAB color scheme
                  </a>
                </label>

                <input type="checkbox" id="useLAB"></input>
              </div>
            </div>
          </div>

          <div class="nonSliderInputs col withspace">
            <div class="centre">
              <div id="generatePDFBtn" class="col">
                <span id="downloadTheWord">Download</span>
                <span id="instructionsTheWord">Instructions</span>
              </div>
            </div>
            <div class="centre">
              <input type="submit" id="resetBtn" value="Reset"></input>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

</body>

<script type="text/javascript">
  'use strict'

  // I am certain that CORS will be a PITA. How to deal?
  // Nothing is easy in web development :(
  const fileSelection = document.getElementById("albumArtIn")
  const urlSelection = document.getElementById("albumArtURL")
  const urlSelectionBtn = document.getElementById("albumArtURLBtn")
  const urlSubmission = document.getElementById("urlSubmission")
  const albumName = document.getElementById("albumName")
  const resetButton = document.getElementById("resetBtn")
  const useLABCheck = document.getElementById("useLAB")
  const sizeSlider = document.getElementById("size")
  const satSlider = document.getElementById("saturation")
  const brightSlider = document.getElementById("brightness")
  const contrastSlider = document.getElementById("contrast")
  const sizeLabel = document.getElementById("sizeLabel")
  const generatePDFBtn = document.getElementById("generatePDFBtn")
  const errTextBox = document.getElementById("errText")

  fileSelection.addEventListener("change", e => handleFile(e.target.files[0]))
  urlSubmission.addEventListener("submit", e => {
    e.preventDefault()
    handleURL(urlSelection.value)
  })
  resetButton.addEventListener("click", reset)
  useLABCheck.addEventListener("change", legoify)
  sizeSlider.addEventListener("input", updateSize)
  satSlider.addEventListener("input", legoify)
  brightSlider.addEventListener("input", legoify)
  contrastSlider.addEventListener("input", legoify)
  generatePDFBtn.addEventListener("click", genInstructions)

  let fxcanvas
  try { fxcanvas = fx.canvas() } catch (e) {
    alert("Sorry, your browser does not support WebGL. Create an issue here? https://github.com/jeremyvoldeng/legoMosaicMaker/issues/new\nLove, Axel")
  }
  fxcanvas.id = "incvs"
  fxcanvas.className = "displayCanvas"

  const output_canvas = document.getElementById("outcvs")
  const out_ctx = output_canvas.getContext('2d')

  let L;
  let input_texture;
  let album_art_img;

  function handleURL(url) {
    /*
    initial tesitng

    https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image
    https://javascript.info/fetch-crossorigin

    kinda works!

    */
    hideError()
    const errMsg = "Could not load image from your URL - make sure that the link is to JUST an image, and nothing else. This can be a bit finicky!"

    fetch(url, {
      method: 'GET',
      mode: 'cors',
      cache: 'default',
      credentials: 'same-origin',
      redirect: 'follow',
      referrer: 'no-referrer',
    })
      .then(response => {
        if (response.ok) {
          return response.blob()
        } else {
          showError(errMsg)
        }
      })
      .then(blob => handleFile(blob))
      .catch(error => {
        showError(errMsg)
      })
  }

  function handleFile(file) {
    album_art_img = new Image
    const album_art_url = URL.createObjectURL(file)

    album_art_img.onload = (data) => {
      if (imgRequiresResize(album_art_img)) {
        showError("Your image has dimensions that we can not handle. "
          + "We need square images with edges larger than 64px and smaller than 1500px. "
          + "Your image is " + album_art_img.width + " by " + album_art_img.height
        )

        hideContents()
        return
      } else {
        hideError()
        showContents()
      }

      input_texture = fxcanvas.texture(album_art_img)

      // either this, or EXT_color_buffer_float
      input_texture._.gl.getExtension('WEBGL_color_buffer_float')

      L = new Legoificator(input_texture, parseInt(sizeSlider.value))
      reset()

      document.getElementById("imgdiv").prepend(fxcanvas)
    }

    album_art_img.src = album_art_url
  }

  function reset() {
    useLABCheck.checked = false
    sizeSlider.value = 3
    contrastSlider.value = 0
    brightSlider.value = 0
    satSlider.value = 0
    albumName.value = ""
    albumArtURL.value = ""

    updateSize()

    if (L) {
      input_texture.loadContentsOf(album_art_img)
      fxcanvas.draw(input_texture).update()
      L.updateSize(parseInt(sizeSlider.value))
      L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
    }
  }

  function legoify() {
    if (L) {
      input_texture.loadContentsOf(album_art_img)
      fxcanvas.draw(input_texture)
        .hueSaturation(0, satSlider.value)
        .brightnessContrast(brightSlider.value, contrastSlider.value)
        .update()

      L.updateSize(parseInt(sizeSlider.value))
      L.updateLegoificatedEntity(out_ctx, useLABCheck.checked)
    }
  }

  function genInstructions() {
    if (L) {
      const mosaic = output_canvas.toDataURL('image/png')
      L.makeMosaicInstructions(
        albumName.value,
        mosaic,
        output_canvas.width,
        output_canvas.height
      )
    }
  }

  function updateSize() {
    sizeLabel.innerHTML = `Size: ${16 * sizeSlider.value} by ${16 * sizeSlider.value}`
    legoify()
  }

  function imgRequiresResize(img) {
    const minDim = 64
    const unevenAspectRatio = img.width != img.height
    const tooSmall = img.width < minDim || img.height < minDim
    return tooSmall || unevenAspectRatio
  }

  function showContents() {
    // gotta be flex, or else the styling just falls apart
    document.getElementById("hideableContent").style.display = "block"
    document.getElementById("initialMessage").style.display = "none"
  }

  function hideContents() {
    document.getElementById("hideableContent").style.display = "none"
    document.getElementById("initialMessage").style.display = "block"
  }

  function showError(msg) {
    errTextBox.innerText = msg
    errTextBox.style.display = "block"
  }

  function hideError() {
    errTextBox.innerText = ""
    errTextBox.style.display = "none"
  }

  function linspace(start, stop, num) {
    const div = num
    const step = (stop - start) / div
    return Array.from({ length: num }, (_, i) => start + step * i)
  }

  function testMe() {
    console.log("starting test")
    for (let LAB of [false, true]) {
      for (let size of [1, 2, 3, 4]) {
        for (let saturation of linspace(-0.2, 0.2, 3)) {
          for (let bright of linspace(-0.2, 0.2, 3)) {
            for (let contrast of linspace(-0.2, 0.2, 3)) {
              input_texture.loadContentsOf(album_art_img)
              fxcanvas.draw(input_texture)
                .hueSaturation(0, saturation)
                .brightnessContrast(bright, contrast)
                .update()

              L.updateSize(size)
              L.updateLegoificatedEntity(out_ctx, LAB)
            }
          }
        }
      }
    }
    console.log("test done")
  }
</script>

</html>